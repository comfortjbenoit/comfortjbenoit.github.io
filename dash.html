<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Intranet Dashboard</title>
  <meta name="theme-color" content="#111827" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { borderRadius: { '2xl': '1rem' }}}};
  </script>
  <style>
    html, body { height: 100%; background: #f8fafc; }
    .aspect-video { position: relative; padding-top: calc(9/16 * 100%); }
    .aspect-video > * { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; border: 0; }
    .container { max-width: 72rem; margin-left: auto; margin-right: auto; padding-left: 1rem; padding-right: 1rem; }
    @media (min-width: 640px){ .container { padding-left: 1.5rem; padding-right: 1.5rem; } }
    @media (min-width: 1024px){ .container { padding-left: 2rem; padding-right: 2rem; } }
  </style>
</head>
<body class="min-h-screen">

  <!-- Top Bar -->
  <div class="bg-white border-b border-gray-200">
    <div class="container">
      <div class="flex items-center gap-4 py-4">
        <div class="flex items-center gap-2">
          <div class="h-9 w-9 rounded-xl bg-gray-900 text-white flex items-center justify-center font-bold">FT</div>
          <div id="orgName" class="text-xl font-semibold text-gray-900">Food Town Intranet</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Location banner -->
  <div id="locBanner" class="hidden bg-amber-50 border-b border-amber-200">
    <div class="container"><div class="py-2 text-sm text-amber-900" id="locMsg"></div></div>
  </div>

  <!-- Main: Sidebar + Content -->
  <main class="container">
    <div class="py-6 grid grid-cols-12 gap-6">
      <!-- Left sidebar nav -->
      <aside class="col-span-12 md:col-span-3 lg:col-span-2">
        <nav id="sideNav" class="bg-white border border-gray-200 rounded-2xl p-2 sticky top-4"></nav>
      </aside>

      <!-- App content -->
      <section id="app" class="col-span-12 md:col-span-9 lg:col-span-10"></section>
    </div>
  </main>

  <!-- Footer -->
  <footer class="mt-2 border-t border-gray-200 bg-white">
    <div class="container">
      <div class="py-4 text-xs text-gray-500">
        Â© <span id="year"></span> <span id="orgNameFooter">Food Town Intranet</span>
      </div>
    </div>
  </footer>

  <!-- Mobile tabs -->
  <div class="md:hidden sticky bottom-0 inset-x-0 bg-white border-t border-gray-200 p-2 flex justify-between z-10" id="mobileTabs"></div>

  <script>
    const NAV_ITEMS = [
      { path: '/', label: 'Dashboard' },
      { path: '/reports', label: 'Reports' },
      { path: '/manuals', label: 'Manuals' },
      { path: '/planograms', label: 'Planograms' },
      { path: '/corporate', label: 'Corporate' },
      { path: '/store', label: 'Store' },
      { path: '/booth', label: 'Booth' },
      { path: '/scan', label: 'Scan' },
      { path: '/receiving', label: 'Receiving' },
    ];
    const PERMA_EBT_DAYS = [1,3,5,6,7,9,11,12,13,15];
    const $ = (sel) => document.querySelector(sel);
    const el = (tag, cls, html) => { const e=document.createElement(tag); if(cls)e.className=cls; if(html!=null)e.innerHTML=html; return e; };

    /**************
     * EBT CALENDAR (fixed)
     **************/
    function daysInMonth(y, m){ return new Date(y, m+1, 0).getDate(); }
    function getMonthGrid(y, m){
      const first = new Date(y, m, 1), start = first.getDay(), total = daysInMonth(y, m), cells = [];
      for (let i=0;i<start;i++) cells.push(null);
      for (let d=1; d<=total; d++) cells.push(d);
      while (cells.length % 7) cells.push(null);
      return cells;
    }
    function renderEBTCalendar(container){
      const now = new Date();
      const y = now.getFullYear(), m = now.getMonth();
      const cells = getMonthGrid(y, m);
      const monthName = now.toLocaleString(undefined, { month: 'long' });

      const card = el('div','bg-white shadow-sm rounded-2xl p-5 border border-gray-100 h-full');
      const header = el('div','flex items-center justify-between mb-3');
      header.innerHTML = `<h3 class="text-lg font-semibold text-gray-800">EBT Activation Days â€” ${monthName} ${y}</h3>`;
      card.appendChild(header);

      const grid = el('div','grid grid-cols-7 gap-2 text-xs text-gray-600');
      ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => grid.appendChild(el('div','text-center font-semibold text-gray-700', d)));

      const maxDay = daysInMonth(y, m);
      const selected = new Set(PERMA_EBT_DAYS.filter(d => d >= 1 && d <= maxDay));
      for (const day of cells){
        const cell = el('div','aspect-square rounded-xl border flex items-center justify-center');
        if (day == null){
          cell.className += ' bg-gray-50 border-gray-100';
        } else if (selected.has(day)){
          cell.className += ' bg-[rgba(128,0,0,0.12)] border-[rgba(128,0,0,0.35)] text-[#800000] font-semibold';
          cell.textContent = day;
        } else {
          cell.className += ' bg-white border-gray-200 text-gray-900';
          cell.textContent = day;
        }
        grid.appendChild(cell);
      }
      card.appendChild(grid);
      container.appendChild(card);
    }

    /**************
     * Condensed Weather Widget
     **************/
    const WCODE = {0:'â˜€ï¸',1:'ðŸŒ¤ï¸',2:'â›…',3:'â˜ï¸',45:'ðŸŒ«ï¸',48:'ðŸŒ«ï¸',61:'ðŸŒ§ï¸',63:'ðŸŒ§ï¸',65:'ðŸŒ§ï¸',80:'ðŸŒ§ï¸',81:'ðŸŒ§ï¸',82:'â›ˆï¸',95:'â›ˆï¸'};
    async function fetchForecast(lat, lon){
      const url = new URL('https://api.open-meteo.com/v1/forecast');
      url.searchParams.set('latitude', lat);
      url.searchParams.set('longitude', lon);
      url.searchParams.set('hourly','temperature_2m,precipitation,weathercode');
      url.searchParams.set('current_weather','true');
      url.searchParams.set('temperature_unit','fahrenheit');
      url.searchParams.set('timezone','auto');
      const res = await fetch(url.toString());
      return res.json();
    }
    function renderWeather(container, coords){
      container.innerHTML='';
      const card = el('div','bg-white shadow-sm rounded-2xl px-4 py-3 border border-gray-100');
      const row = el('div','flex items-center gap-4 overflow-x-auto');
      row.appendChild(el('div','shrink-0 text-sm font-semibold text-gray-800','Weather'));
      const status = el('div','text-sm text-gray-500','Loadingâ€¦');
      row.appendChild(status); card.appendChild(row); container.appendChild(card);

      if (!coords){ status.textContent='Locatingâ€¦'; return; }
      fetchForecast(coords.lat, coords.lon).then(data=>{
        status.remove();
        const cw=data.current_weather;
        if(cw){
          const cur = el('div','shrink-0 flex items-center gap-2 px-2 py-1 rounded-lg border border-gray-200',
            `<span class="text-lg">${WCODE[cw.weathercode]||''}</span>
             <span class="text-sm font-medium">${Math.round(cw.temperature)}Â°F</span>
             <span class="text-xs text-gray-500">W ${Math.round(cw.windspeed)} mph</span>`);
          row.appendChild(cur);
        }
      });
    }

    /**************
     * Live Maps (DriveTexas + KTRK)
     **************/
    function renderLiveMaps(container){
      container.innerHTML='';
      const grid=el('div','grid grid-cols-1 lg:grid-cols-2 gap-5');

      // Traffic
      const radar=el('div','bg-white shadow-sm rounded-2xl p-5 border border-gray-100');
      radar.innerHTML=`
        <div class="flex items-center justify-between mb-3"><h3 class="text-lg font-semibold text-gray-800">Weather Radar (KTRK)</h3></div>
        <div class="aspect-video rounded-xl overflow-hidden border">
          <img src="https://traffic.houstontranstar.org/data/layers/houston_region_layer_speed.gif" alt="Houston Traffic" class="w-full h-full object-cover"/>
        </div>`;
      grid.appendChild(traffic);
  
      // Weather Radar (KTRK)
      const radar=el('div','bg-white shadow-sm rounded-2xl p-5 border border-gray-100');
      radar.innerHTML=`
        <div class="flex items-center justify-between mb-3"><h3 class="text-lg font-semibold text-gray-800">Weather Radar (KTRK)</h3></div>
        <div class="aspect-video rounded-xl overflow-hidden border">
          <img src="https://cdns.abclocal.go.com/three/ktrk/weather/WWW_KTRK_5DAY_HD.jpg?w=300&r=16%3A9" alt="KTRK Weather" class="w-full h-full object-cover"/>
        </div>`;
      grid.appendChild(radar);

      container.appendChild(grid);

      // auto-refresh DriveTexas every 5 min
      const MINUTES=5;
      setInterval(()=>{
        const f=document.getElementById('drivetexas');
        if(f){ f.src="https://static.drivetexas.org/?t="+Date.now(); }
      },MINUTES*60*1000);
    }

    /**************
     * Dashboard
     **************/
    let CURRENT_COORDS={lat:29.6658,lon:-95.0194}; // fallback
    function renderDashboard(){
      const app=$('#app'); app.innerHTML='';
      const header=el('div','mb-5','<h1 class="text-2xl font-semibold text-gray-900">Dashboard</h1>');
      app.appendChild(header);

      const grid=el('div','grid grid-cols-1 lg:grid-cols-3 gap-5');
      const left=el('div','lg:col-span-1'); renderEBTCalendar(left);
      const rightCol=el('div','lg:col-span-2'); renderLiveMaps(rightCol);
      grid.append(left,rightCol);
      app.appendChild(grid);

      const wx=el('div','mt-5'); app.appendChild(wx);
      renderWeather(wx,CURRENT_COORDS);
    }

    /**************
     * Router + Nav
     **************/
    function renderRoute(route){ if(route==='/'){renderDashboard();} }
    function buildNav(){
      const side=$('#sideNav'); side.innerHTML='';
      const tabs=$('#mobileTabs'); tabs.innerHTML='';
      const list=el('div','flex flex-col');
      for(const item of NAV_ITEMS){
        const a=el('a','px-3 py-2 rounded-xl text-sm font-medium text-gray-700 hover:bg-gray-100',item.label);
        a.href='#'+item.path; a.dataset.path=item.path; list.appendChild(a);
        const m=el('a','flex-1 text-center text-xs font-medium text-gray-700 py-2 hover:bg-gray-100 rounded-lg',item.label);
        m.href='#'+item.path; tabs.appendChild(m);
      }
      side.appendChild(list);
    }

    function renderAll(){ buildNav(); renderRoute('/'); $('#year').textContent=new Date().getFullYear(); }
    renderAll();
  </script>
</body>
</html>
