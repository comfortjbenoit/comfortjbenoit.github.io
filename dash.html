<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Intranet Dashboard</title>
  <meta name="theme-color" content="#111827" />
  <!-- Normalize & Tailwind (no build tools needed) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { borderRadius: { '2xl': '1rem' }}}};
  </script>
  <style>
    html, body { height: 100%; background: #f8fafc; }
    .aspect-video { position: relative; padding-top: calc(9/16 * 100%); }
    .aspect-video > iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: 0; }
    .container { max-width: 72rem; margin-left: auto; margin-right: auto; padding-left: 1rem; padding-right: 1rem; }
    @media (min-width: 640px){ .container { padding-left: 1.5rem; padding-right: 1.5rem; } }
    @media (min-width: 1024px){ .container { padding-left: 2rem; padding-right: 2rem; } }
  </style>
</head>
<body class="min-h-screen">

  <!-- Top Bar -->
  <div class="bg-white border-b border-gray-200">
    <div class="container">
      <div class="flex items-center gap-4 py-4">
        <div class="flex items-center gap-2">
          <div class="h-9 w-9 rounded-xl bg-gray-900 text-white flex items-center justify-center font-bold">FT</div>
          <div id="orgName" class="text-xl font-semibold text-gray-900">Food Town Intranet</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Location banner -->
  <div id="locBanner" class="hidden bg-amber-50 border-b border-amber-200">
    <div class="container"><div class="py-2 text-sm text-amber-900" id="locMsg"></div></div>
  </div>

  <!-- Main: Sidebar + Content -->
  <main class="container">
    <div class="py-6 grid grid-cols-12 gap-6">
      <!-- Left sidebar nav -->
      <aside class="col-span-12 md:col-span-3 lg:col-span-2">
        <nav id="sideNav" class="bg-white border border-gray-200 rounded-2xl p-2 sticky top-4"></nav>
      </aside>

      <!-- App content -->
      <section id="app" class="col-span-12 md:col-span-9 lg:col-span-10"></section>
    </div>
  </main>

  <!-- Footer (links removed) -->
  <footer class="mt-2 border-t border-gray-200 bg-white">
    <div class="container">
      <div class="py-4 text-xs text-gray-500">
        © <span id="year"></span> <span id="orgNameFooter">Food Town Intranet</span>
      </div>
    </div>
  </footer>

  <!-- Mobile tabs -->
  <div class="md:hidden sticky bottom-0 inset-x-0 bg-white border-t border-gray-200 p-2 flex justify-between z-10" id="mobileTabs"></div>

  <script>
    /**************
     * CONFIG + PERSISTENCE
     **************/
    const NAV_ITEMS = [
      { path: '/', label: 'Dashboard' },
      { path: '/reports', label: 'Reports' },
      { path: '/manuals', label: 'Manuals' },
      { path: '/planograms', label: 'Planograms' },
      { path: '/corporate', label: 'Corporate' },
      { path: '/store', label: 'Store' },
      { path: '/booth', label: 'Booth' },
      { path: '/scan', label: 'Scan' },
      { path: '/receiving', label: 'Receiving' },
    ];
    const PERMA_EBT_DAYS = [1,3,5,6,7,9,11,12,13,15]; // fixed days
    const LS_KEY = 'intranet_dashboard_config_v1';
    const defaultConfig = {
      orgName: 'Food Town Intranet',
      homeCenter: { lat: 29.6658, lon: -95.0194, zoom: 10 }, // La Porte, TX default
      sections: { reports: [], manuals: [], planograms: [], corporate: [], store: [], booth: [], scan: [], receiving: [] },
      ebtDaysByMonth: {}, // ignored now that PERMA_EBT_DAYS is fixed
    };
    function loadConfig() {
      try { return { ...defaultConfig, ...(JSON.parse(localStorage.getItem(LS_KEY)) || {}) }; }
      catch { return defaultConfig; }
    }
    function saveConfig(cfg) { localStorage.setItem(LS_KEY, JSON.stringify(cfg)); }

    let CONFIG = loadConfig();

    /**************
     * UTIL
     **************/
    const $ = (sel) => document.querySelector(sel);
    const el = (tag, cls, html) => {
      const e = document.createElement(tag);
      if (cls) e.className = cls;
      if (html != null) e.innerHTML = html;
      return e;
    };
    function setHash(path){ if (location.hash !== '#' + path) location.hash = '#' + path; }
    function getRoute(){ return (location.hash || '#/').slice(1); }
    function yyyymm(d = new Date()){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
    function daysInMonth(y, m){ return new Date(y, m+1, 0).getDate(); }
    function getMonthGrid(y, m){
      const first = new Date(y, m, 1), start = first.getDay(), total = daysInMonth(y, m), cells = [];
      for (let i=0;i<start;i++) cells.push(null);
      for (let d=1; d<=total; d++) cells.push(d);
      while (cells.length % 7) cells.push(null);
      return cells;
    }

    /**************
     * WEATHER (Open-Meteo) — condensed one-row card
     **************/
    const WCODE = { 0:'☀️',1:'🌤️',2:'⛅',3:'☁️',45:'🌫️',48:'🌫️',51:'🌦️',53:'🌦️',55:'🌧️',61:'🌧️',63:'🌧️',65:'🌧️',71:'🌨️',73:'🌨️',75:'❄️',80:'🌧️',81:'🌧️',82:'⛈️',95:'⛈️',96:'⛈️',99:'⛈️' };

    async function fetchForecast(lat, lon){
      const url = new URL('https://api.open-meteo.com/v1/forecast');
      url.searchParams.set('latitude', lat);
      url.searchParams.set('longitude', lon);
      url.searchParams.set('hourly', 'temperature_2m,precipitation,weathercode');
      url.searchParams.set('current_weather', 'true');
      url.searchParams.set('temperature_unit', 'fahrenheit');
      url.searchParams.set('timezone', 'auto');
      const res = await fetch(url.toString());
      if (!res.ok) throw new Error('Weather fetch failed');
      return res.json();
    }

    function renderWeather(container, coords){
      container.innerHTML = '';
      const card = el('div','bg-white shadow-sm rounded-2xl px-4 py-3 border border-gray-100');
      const row = el('div','flex items-center gap-4 overflow-x-auto');
      const title = el('div','shrink-0 text-sm font-semibold text-gray-800','Weather');
      row.appendChild(title);

      const status = el('div','text-sm text-gray-500','Loading…');
      row.appendChild(status);
      card.appendChild(row);
      container.appendChild(card);

      if (!coords){ status.textContent = 'Locating…'; return; }

      fetchForecast(coords.lat, coords.lon).then(data => {
        status.remove();

        const cw = data.current_weather;
        if (cw){
          const cur = el('div','shrink-0 flex items-center gap-2 px-2 py-1 rounded-lg border border-gray-200');
          cur.innerHTML = `
            <span class="text-lg">${WCODE[cw.weathercode] || ''}</span>
            <span class="text-sm font-medium">${Math.round(cw.temperature)}°F</span>
            <span class="text-xs text-gray-500">W ${Math.round(cw.windspeed)} mph</span>
            <span class="ml-2 text-[11px] text-gray-500">${coords.lat.toFixed(2)}, ${coords.lon.toFixed(2)}</span>`;
          row.appendChild(cur);
        }

        const hours = (data.hourly?.time || []).map((t,i)=>({
          time: t,
          temp: data.hourly.temperature_2m[i],
          wcode: data.hourly.weathercode[i],
          precip: data.hourly.precipitation[i],
        }));
        const nowIso = new Date().toISOString().slice(0,13);
        const upcoming = hours.filter(h => h.time.slice(0,13) >= nowIso).slice(0,6);

        const strip = el('div','flex items-center gap-2');
        for (const h of upcoming){
          const dt = new Date(h.time);
          const label = dt.toLocaleTimeString([], { hour: 'numeric' });
          const chip = el('div','shrink-0 flex items-center gap-1 px-2 py-1 rounded-lg border border-gray-200 text-xs');
          chip.innerHTML = `
            <span>${label}</span>
            <span class="text-base leading-none">${WCODE[h.wcode] || ''}</span>
            <span class="font-medium">${Math.round(h.temp)}°</span>`;
          strip.appendChild(chip);
        }
        row.appendChild(strip);
      }).catch(e => {
        status.className = 'text-sm text-red-600';
        status.textContent = String(e);
      });
    }

    /**************
     * LIVE MAPS (Waze + Windy embeds)
     **************/
    function renderLiveMaps(container, coords, center){
      container.innerHTML = '';
      const lat = coords?.lat ?? center.lat;
      const lon = coords?.lon ?? center.lon;
      const wazeSrc = `https://embed.waze.com/iframe?zoom=12&lat=${lat}&lon=${lon}&pin=1`;
      const windySrc = `https://embed.windy.com/embed2.html?lat=${lat}&lon=${lon}&zoom=7&level=surface&overlay=radar&menu=&message=true&marker=&calendar=&pressure=&type=map&location=coordinates&detail=&detailLat=${lat}&detailLon=${lon}&metricWind=mph&metricTemp=%C2%B0F`;

      const grid = el('div','grid grid-cols-1 lg:grid-cols-2 gap-5');

      const traffic = el('div','bg-white shadow-sm rounded-2xl p-5 border border-gray-100');
      traffic.innerHTML = `<div class="flex items-center justify-between mb-3"><h3 class="text-lg font-semibold text-gray-800">Live Traffic (Waze)</h3></div>
                           <div class="aspect-video rounded-xl overflow-hidden border"><iframe title="Waze" src="${wazeSrc}" allowfullscreen></iframe></div>`;
      grid.appendChild(traffic);

      const radar = el('div','bg-white shadow-sm rounded-2xl p-5 border border-gray-100');
      radar.innerHTML = `<div class="flex items-center justify-between mb-3"><h3 class="text-lg font-semibold text-gray-800">Weather Radar (Windy)</h3></div>
                         <div class="aspect-video rounded-xl overflow-hidden border"><iframe title="Windy" src="${windySrc}" loading="lazy"></iframe></div>`;
      grid.appendChild(radar);

      container.appendChild(grid);
    }

    /**************
     * EBT CALENDAR (fixed days, maroon highlight)
     **************/
    function renderEBTCalendar(container){
      const now = new Date();
      const y = now.getFullYear();
      const m = now.getMonth();
      const cells = getMonthGrid(y, m);
      const monthName = now.toLocaleString(undefined, { month: 'long' });

      const card = el('div','bg-white shadow-sm rounded-2xl p-5 border border-gray-100 h-full');
      const header = el('div','flex items-center justify-between mb-3');
      header.innerHTML = `<h3 class="text-lg font-semibold text-gray-800">EBT Activation Days — ${monthName} ${y}</h3>`;
      card.appendChild(header);

      const grid = el('div','grid grid-cols-7 gap-2 text-xs text-gray-600');
      ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => {
        const w = el('div','text-center font-semibold text-gray-700', d);
        grid.appendChild(w);
      });

      const maxDay = daysInMonth(y, m);
      const selected = new Set(PERMA_EBT_DAYS.filter(d => d >= 1 && d <= maxDay));

      for (const day of cells){
        const cell = el('div','aspect-square rounded-xl border flex items-center justify-center');
        if (day == null){
          cell.className += ' bg-gray-50 border-gray-100';
          cell.textContent = '';
        } else if (selected.has(day)){
          /* maroon transparent highlight */
          cell.className += ' bg-[rgba(128,0,0,0.12)] border-[rgba(128,0,0,0.35)] text-[#800000] font-semibold';
          cell.textContent = day;
        } else {
          cell.className += ' bg-white border-gray-200 text-gray-900';
          cell.textContent = day;
        }
        grid.appendChild(cell);
      }
      card.appendChild(grid);

      container.appendChild(card);
    }

    /**************
     * LINK GRID FOR SECTION PAGES
     **************/
    function renderLinkGrid(container, sectionName, title){
      container.innerHTML = '';
      const card = el('div','bg-white shadow-sm rounded-2xl p-5 border border-gray-100');
      const header = el('div','flex items-center justify-between mb-3');
      header.innerHTML = `<h3 class="text-lg font-semibold text-gray-800">${title}</h3>`;
      const addBtn = el('button','inline-flex items-center justify-center rounded-xl font-medium transition focus:outline-none focus:ring-2 focus:ring-offset-2 text-sm px-4 py-2 border border-gray-300 text-gray-800 hover:bg-gray-50 focus:ring-gray-300','Add Link');
      addBtn.onclick = () => {
        const ttl = prompt('Link title'); if (!ttl) return;
        const href = prompt('URL (https://…)'); if (!href) return;
        const desc = prompt('Optional description') || '';
        const icon = prompt('Optional emoji/icon (e.g. 📊, 📄, 🗂️)') || '';
        const items = CONFIG.sections[sectionName] || [];
        CONFIG.sections[sectionName] = [...items, { title: ttl, href, desc, icon }];
        saveConfig(CONFIG);
        renderRoute(getRoute());
      };
      header.appendChild(addBtn);
      card.appendChild(header);

      const items = CONFIG.sections[sectionName] || [];
      if (!items.length){
        card.appendChild(el('p','text-sm text-gray-500','No links yet. Use “Add Link” to populate this section.'));
      } else {
        const grid = el('div','grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4');
        for (const it of items){
          const a = el('a','group block rounded-2xl border border-gray-200 p-4 hover:border-gray-300 hover:shadow-sm');
          a.href = it.href; a.target = '_blank'; a.rel = 'noreferrer';
          a.innerHTML = `
            <div class="flex items-center gap-3">
              <div class="h-10 w-10 flex items-center justify-center rounded-xl bg-gray-100 group-hover:bg-gray-200 font-semibold text-gray-700">${it.icon || '🔗'}</div>
              <div>
                <div class="font-medium text-gray-900">${it.title}</div>
                ${it.desc ? `<div class="text-sm text-gray-600">${it.desc}</div>` : ''}
              </div>
            </div>`;
          grid.appendChild(a);
        }
        card.appendChild(grid);
      }
      container.appendChild(card);
    }

    /**************
     * DASHBOARD PAGE
     **************/
    function renderDashboard(){
      const app = $('#app'); app.innerHTML = '';

      const header = el('div','flex items-center justify-between mb-5');
      header.innerHTML = `
        <div>
          <h1 class="text-2xl font-semibold text-gray-900">Dashboard</h1>
          <p class="text-sm text-gray-600">Live traffic & weather, plus this month’s EBT activation days.</p>
        </div>`;
      app.appendChild(header);

      const grid = el('div','grid grid-cols-1 lg:grid-cols-3 gap-5');
      const left = el('div','lg:col-span-1'); renderEBTCalendar(left);
      const rightCol = el('div','lg:col-span-2'); renderLiveMaps(rightCol, CURRENT_COORDS, CONFIG.homeCenter);
      grid.append(left, rightCol);
      app.appendChild(grid);

      const wx = el('div','mt-5'); app.appendChild(wx);
      renderWeather(wx, CURRENT_COORDS);
    }

    /**************
     * SECTION ROUTER
     **************/
    function renderRoute(route){
      $('#orgName').textContent = CONFIG.orgName;
      $('#orgNameFooter').textContent = CONFIG.orgName;
      $('#year').textContent = new Date().getFullYear();

      const titleMap = {
        '/': 'Dashboard',
        '/reports': 'Reports',
        '/manuals': 'Manuals',
        '/planograms': 'Planograms',
        '/corporate': 'Corporate',
        '/store': 'Store',
        '/booth': 'Booth',
        '/scan': 'Scan',
        '/receiving': 'Receiving',
      };

      if (route === '/') return renderDashboard();

      const app = $('#app'); app.innerHTML = '';
      const header = el('div','flex items-center justify-between mb-5');
      header.innerHTML = `<h1 class="text-2xl font-semibold text-gray-900">${titleMap[route] || 'Section'}</h1>`;
      app.appendChild(header);

      const sectionName = route.replace('/','');
      renderLinkGrid(app, sectionName, titleMap[route] || sectionName);

      // Update active state in sidebar
      highlightActive(route);
    }

    /**************
     * SIDEBAR + MOBILE TABS
     **************/
    function buildNav(){
      const side = $('#sideNav'); side.innerHTML = '';
      const tabs = $('#mobileTabs'); tabs.innerHTML = '';

      const list = el('div','flex flex-col');
      for (const item of NAV_ITEMS){
        const a = el('a','px-3 py-2 rounded-xl text-sm font-medium text-gray-700 hover:bg-gray-100', item.label);
        a.href = '#' + item.path;
        a.dataset.path = item.path;
        list.appendChild(a);

        const m = el('a','flex-1 text-center text-xs font-medium text-gray-700 py-2 hover:bg-gray-100 rounded-lg', item.label);
        m.href = '#' + item.path;
        tabs.appendChild(m);
      }
      side.appendChild(list);

      highlightActive(getRoute());
    }

    function highlightActive(route){
      // route like "/reports"
      const current = route || '/';
      document.querySelectorAll('#sideNav a').forEach(a => {
        const isActive = a.dataset.path === current;
        a.classList.toggle('bg-gray-900', isActive);
        a.classList.toggle('text-white', isActive);
        a.classList.toggle('hover:bg-gray-100', !isActive);
      });
    }

    /**************
     * GEOLOCATION + INITIAL RENDER
     **************/
    let CURRENT_COORDS = null;

    function setLocBanner(msg){
      if (!msg){ $('#locBanner').classList.add('hidden'); $('#locMsg').textContent = ''; return; }
      $('#locBanner').classList.remove('hidden');
      $('#locMsg').textContent = msg;
    }

    function locate(){
      if (!('geolocation' in navigator)){
        setLocBanner('Geolocation not supported. Using default center.');
        CURRENT_COORDS = { lat: CONFIG.homeCenter.lat, lon: CONFIG.homeCenter.lon };
        return Promise.resolve(CURRENT_COORDS);
      }
      setLocBanner('Locating… If the prompt is blocked, we’ll use the default center.');
      return new Promise((resolve) => {
        const timer = setTimeout(() => setLocBanner('If location is blocked, using default center.'), 4000);
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            clearTimeout(timer);
            setLocBanner('');
            CURRENT_COORDS = { lat: pos.coords.latitude, lon: pos.coords.longitude };
            resolve(CURRENT_COORDS);
          },
          () => {
            clearTimeout(timer);
            setLocBanner('Using default center.');
            CURRENT_COORDS = { lat: CONFIG.homeCenter.lat, lon: CONFIG.homeCenter.lon };
            resolve(CURRENT_COORDS);
          },
          { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 }
        );
      });
    }

    function renderAll(){
      buildNav();
      renderRoute(getRoute());
    }

    window.addEventListener('hashchange', () => {
      renderRoute(getRoute());
      highlightActive(getRoute());
    });

    // Boot
    (async function init(){
      await locate();
      renderAll();
    })();
  </script>
</body>
</html>
